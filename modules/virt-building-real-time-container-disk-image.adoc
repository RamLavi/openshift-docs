// Module included in the following assemblies:
//
// * virt//support/monitoring/virt-running-cluster-checkups.adoc

:_mod-docs-content-type: PROCEDURE
[id="virt-building-realtime-container-disk-image_{context}"]
= Building a container disk image for {op-system-base} virtual machines

You can create a custom {op-system-base-full} 9 Operating system image in `QCOW2` format and use it to create a container disk image. You can store the container disk image in a registry that is accessible from your cluster and specify the image location in the `spec.param.vmUnderTestContainerDiskImage` attribute of the real-time checkup config map.

.Procedure

. Run a {op-system-base-full} 9 Operating system image and set the root password to "redhat"

. Login as root and install the following packages:
** kernel-rt
** tuned
** tuned-profiles-realtime
** tuned-profiles-nfv-guest
** rt-tests
** cloud-init
----
+
[NOTE]
====
You may need to enable to following repositories on subscription-manager:
** rhel-9-for-x86_64-rt-rpms
** rhel-9-for-x86_64-nfv-rpms
====

. Disable the following services from running:
** NetworkManager-wait-online
** sshd
** irqbalance

. Copy this script on the image:
+
[source,terminal]
----
# cat <<EOF >customize-vm.sh
#!/bin/bash

set -xe

# Disable swap
swapoff -a
sed -i '/swap/s/^/#/' /etc/fstab

# Enable guest-exec,guest-exec-status on the qemu-guest-agent configuration
sed -i 's/\(--allow-rpcs=[^"]*\)/\1,guest-exec-status,guest-exec/' /etc/sysconfig/qemu-ga

# Disable Bracketed-paste mode
echo "set enable-bracketed-paste off" >> /root/.inputrc
EOF
----

. Run the script on the image:
+
[source,terminal]
----
# chmod +x customize-vm.sh
# ./customize-vm.sh
----

. Restart the image in order for the changes to take place.

. Export the image to QCOW2 format.

. Create a container disk image:
+
[source,terminal]
----
$ cat << EOF > Dockerfile
FROM scratch
COPY --chown=107:107 disk.qcow2 /disk/
EOF
----
+
where:

disk.qcow2:: Specifies the name of the custom image in `QCOW2` format.

. Build and tag the container by running the following command:
+
[source,terminal]
----
$ podman build . -t realtime-rhel:latest
----

. Push the container disk image to a registry that is accessible from your cluster by running the following command:
+
[source,terminal]
----
$ podman push realtime-rhel:latest
----

. Provide a link to the container disk image in the `spec.param.vmUnderTestContainerDiskImage` attribute in the realtime checkup config map.
