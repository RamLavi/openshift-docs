// Module included in the following assemblies:
//
// * virt//support/monitoring/virt-running-cluster-checkups.adoc

:_mod-docs-content-type: PROCEDURE
[id="virt-building-realtime-container-disk-image_{context}"]
= Building a realtime container disk image for {op-system-base} virtual machines

You can build a custom {op-system-base-full} 8 Operating system image in `QCOW2` format and use it to create a container disk image. You can store the container disk image in a registry that is accessible from your cluster and specify the image location in the `spec.param.vmUnderTestContainerDiskImage` attribute of the realtime checkup config map.

To build a container disk image, you must create an image builder virtual machine (VM). The _image builder VM_ is a {op-system-base} 8 VM that can be used to build custom {op-system-base} images.

.Prerequisites
* The image builder VM must run {op-system-base} 8.7 and must have a minimum of 2 CPU cores, 4 GiB RAM, and 20 GB of free space in the `/var` directory.
* You have installed the image builder tool and its CLI (`composer-cli`) on the VM.

* You have installed the `virt-customize` tool by using the following command:
+
[source,terminal]
----
# dnf install libguestfs-tools
----
* You have installed the Podman CLI tool (`podman`).

.Procedure

. Verify that you can build a {op-system-base} 8.7 image:
+
[source,terminal]
----
# composer-cli distros list
----
+
[NOTE]
====
To run the `composer-cli` commands as non-root, add your user to the `weldr` or `root` groups:

[source,terminal]
----
# usermod -a -G weldr user
----
[source,terminal]
----
$ newgrp weldr
----
====

. Enter the following command to create an image blueprint file in TOML format that contains the packages to be installed, kernel customizations, and the services to be disabled during boot time:
+
[source,terminal]
----
$ cat << EOF > realtime-vm.toml
name = "realtime_image"
description = "Image to use with the realtime checkup"
version = "0.0.2"
distro = "rhel-8.7"

[[packages]]
name = "cloud-init"

[[packages]]
name = "kernel-rt"

[[packages]]
name = "tuned"

[[packages]]
name = "tuned-profiles-realtime"

[[packages]]
name = "tuned-profiles-nfv-guest"

[[packages]]
name = "rt-tests"

[customizations]

[[customizations.user]]
name = "root"
password = "redhat"

[customizations.services]
disabled = ["NetworkManager-wait-online", "sshd", "irqbalance"]
EOF
----

. Push the blueprint file to the image builder tool by running the following command:
+
[source,terminal]
----
# composer-cli blueprints push realtime-vm.toml
----

. Enter the following command to add a resource file in TOML format that contains the repo need in order to install the `kernel-rt` and `tuned-profiles-realtime` packages:
+
[source,terminal]
----
$ cat << EOF > realtime-source.toml
name = "rhel-8.7-rt"
id = "rhel-8.7-rt"
type = "yum-baseurl"
url = "http://download.eng.tlv.redhat.com/released/rhel-8/RHEL-8/8.7.0/RT/x86_64/os/"
check_gpg = false
check_ssl = false
rhsm = true
EOF
----

. Add the resource file to the image builder tool by running the following command:
+
[source,terminal]
----
# composer-cli sources add realtime-source.toml
----

. Enter the following command to add a resource file in TOML format that contains the repo need in order to install the `tuned-profiles-nfv-guest` package:
+
[source,terminal]
----
$ cat << EOF > nfv-source.toml
name = "rhel-8.7-nfv"
id = "rhel-8.7-nfv"
type = "yum-baseurl"
url = "http://download.eng.tlv.redhat.com/released/rhel-8/RHEL-8/8.7.0/NFV/x86_64/os/"
check_gpg = false
check_ssl = false
rhsm = true
EOF
----

. Add the resource file to the image builder tool by running the following command:
+
[source,terminal]
----
# composer-cli sources add nfv-source.toml
----

. Generate the system image by specifying the blueprint name and output file format. The Universally Unique Identifier (UUID) of the image is displayed when you start the compose process.
+
[source,terminal]
----
# composer-cli compose start realtime_image qcow2
----

. Wait for the compose process to complete. The compose status must show `FINISHED` before you can continue to the next step.
+
[source,terminal]
----
# composer-cli compose status
----

. Enter the following command to download the `QCOW2` image file by specifying its UUID:
+
[source,terminal]
----
# composer-cli compose image <UUID>
----

. Create the customization scripts by running the following commands:
+
[source,terminal]
----
$ cat <<EOF >customize-vm
#!/bin/bash

set -xe

# Disable swap
swapoff -a
sed -i '/swap/s/^/#/' /etc/fstab

# Enable guest-exec,guest-exec-status on the qemu-guest-agent configuration
sed -i '/^BLACKLIST_RPC=/ { s/guest-exec-status//; s/guest-exec//g }' /etc/sysconfig/qemu-ga
sed -i '/^BLACKLIST_RPC=/ { s/,\+/,/g; s/^,\|,$//g }' /etc/sysconfig/qemu-ga
EOF
----

. Use the `virt-customize` tool to customize the image generated by the image builder tool:
+
[source,terminal]
----
$ virt-customize -a <UUID>-disk.qcow2 --run=customize-vm --selinux-relabel
----

. To create a Dockerfile that contains all the commands to build the container disk image, enter the following command:
+
[source,terminal]
----
$ cat << EOF > Dockerfile
FROM scratch
COPY --chown=107:107 <UUID>-disk.qcow2 /disk/
EOF
----
+
where:

<UUID>-disk.qcow2:: Specifies the name of the custom image in `QCOW2` format.

. Build and tag the container by running the following command:
+
[source,terminal]
----
$ podman build . -t realtime-rhel:latest
----

. Push the container disk image to a registry that is accessible from your cluster by running the following command:
+
[source,terminal]
----
$ podman push realtime-rhel:latest
----

. Provide a link to the container disk image in the `spec.param.vmUnderTestContainerDiskImage` attribute in the realtime checkup config map.
